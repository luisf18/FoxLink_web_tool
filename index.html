<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoxWire WebTool</title>
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
    <link rel="manifest" href="favicon/site.webmanifest" />
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 30px;
            height: 100vh;
        }

        /* Sidebar ----------------------------------------------- */
        .sidebar {
            width: 300px;
            background: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            height: 100vh;

            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: fixed;
            left: 0;
            top: 0;
        }
        
        .content {
            flex-grow: 1;
            overflow-y: auto;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 16px;
        }

        /*/
        .sidebar h2 {
            color: #333;
            font-size: 22px;
            margin-bottom: 10px;
        }
        /*/

        /*/
        .sidebar h3 {
            color: #555;
            font-size: 18px;
            margin: 2px 0;
        }
        /*/

        .sidebar hr {
            border: none;
            height: 2px;
            background-color: #ccc;
            margin: 10px 0;
        }
        .start-btn {
            
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;

            background-color: #dc3545;
            color: #fff;
            width: 100%;
            margin-bottom: 10px;
        }
        .start-btn.active {
            background-color: #28a745;
        }

        .scan-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3575dc;
            color: #fff;
            width: 100%;
            margin-bottom: 10px;
        }
        .scan-btn.active {
            background-color: #f34500;
        }

        .logo-container {
            /*height: 20%;*/
            /*width: 100%;  Ocupa toda a largura da sidebar */
            text-align: center;
            /*padding-bottom: 20px;*/
            margin-bottom: 0px;
        }

        .logo-container img {
            max-width: 60%;
            /*height: 100%; width: 200px; Ajuste conforme necessário */
            /*opacity: 0.8;*/
        }

        /*.logo-container img:hover {
            opacity: 1;
        }
        */

        .sidebar a {
            display: block;
            color: #3575dc;
            text-decoration: none;
            text-align: center;
            margin-top: 8px;
        }

        /* Sidebar ----------------------------------------------- */


        .devices-container {
            margin-left: 320px;
            flex-grow: 1; /*flex: 1;*/
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            padding: 20px; /* Adicionando espaço no topo para evitar sobreposição */
            max-width: 100vw; /* Garante que não ultrapasse a largura da tela */
            overflow-x: auto; /* Permite rolagem horizontal caso necessário */
        }

        .user-card {
            background: #ffffff;
            /*/width: 350px;/*/
            
            min-width: 350px;
            max-width: 400px;
            /*/max-width: 100%;/*/ /* Evita que os cartões ultrapassem a largura do contêiner */

            min-height: 500px;
            max-height: 550px;

            
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 16px; /* Reduzi o espaçamento entre os elementos */
            justify-content: space-between;

        }
        .user-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-header img {
            width: 70px;
            height: 70px;
            border-radius: 5px;
        }
        .device-title {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .device-info {
            font-size: 1rem;
            color: #666;
        }
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Reduzi o espaçamento entre os inputs */
        }
        .user-info label {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .user-info input {
            flex: 1;
            padding: 3px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .user-info input[type="number"] {
            width: 70px;
        }

        .user-info .wg-status {
            height:  1rem; /* altura igual à altura da janela */
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            background-color: #dc3545;
            /*cursor: pointer;*/
        }

        .user-info .wg-status.ok {
            background-color: #28a745;
        }
        
        /* Gráfico */
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 8px;
        }
        canvas {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%; /* Agora não estica mais */
            height: 80px; /* Reduzi a altura */
        }
        .chart-labels {
            font-size: 0.8rem;
            text-align: center;
            color: #666;
            margin-top: 2px;
        }

        /* Botões */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 5px; /* Reduzi o espaçamento */
        }
        .action-buttons button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            background-color: #007BFF;
            color: #fff;
            transition: background 0.3s ease-in-out;
        }
        .action-buttons button:hover {
            /*background-color: #0056b3;*/
            filter: brightness(90%);
        }
        .action-buttons .save-btn {
            background-color: #dc3545;
        }
        .action-buttons .save-btn.ok {
            background-color: #28a745;
        }

        
        
    </style>
</head>
<body>

<div class="sidebar">

    <div class="content">
        <h2>Web Fox Link</h2>
        <h3 style=" color: #555; font-size: 18px; margin: 2px 0;">Versão beta 0.3</h3>
        <hr>
        <h3 for="opcoes">Link:</h3>
        <select id="opcoes">
            <option value="USBSerial">USB Serial</option>
            <option value="Arduino">Arduino</option>
        </select><br>
        <!--button onclick="fx.check(0,true)">check</button><br-->
        <!--button onclick="fx.command_key(0,FX_S50_REG.cmd_write.RESTORE_KEPP_ADDR,true)">restore</button><br-->
        <!--button onclick="fx.command(0,FX_S50_REG.cmd.READ,null,true)">read</button><br-->
        <hr>
        <h3>Conecte seus dispositivos FoxWire</h3>
        <button class="start-btn" onclick="toggleConnection()">Connectar</button>
        
        <button class="scan-btn" onclick="scan()">scan devices</button>
        
        <div id="progressContainer" style="display:none; width: 100%; background-color: #ddd; border-radius: 5px; margin-top: 10px;">
            <div id="progressBar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px;"></div>
        </div>
        <div id="result"></div>
        <div id="scannedAddresses"></div> <!-- Mostra os endereços buscados -->
        <div id="users"></div>
    </div>


    <!-- Adicionando a logo -->
    <div class="logo-container">
        <img src="logo.png" alt="FoxWire Logo">
    </div>
    <a href="https://github.com/luisf18/FoxLink_web_tool" target="_blank">Github FoxLink webtool</a>
    <a href="https://github.com/luisf18/FXDevices" target="_blank">Github Sensores</a>
</div>

<div class="devices-container" id="cards">
    <!-- Caixas serão adicionadas aqui -->
</div>

<script src="js/foxwire.js"></script>
<script src="js/widgets.js"></script>
<script src="js/fxs50.js"></script>
<script src="js/IR_KEY.js"></script>

<script>

    const fx = new FoxWire(115200);

    // seletor do tipo de placa que ira fazer o link os os sensores
    async function selectLink( link_name ){
        console.log("Selecionado:", link_name);
        if( link_name == "Arduino" ){
            fx.timeout_read = 15;
            fx.timeout_write = 5;
            fx.retry = 5;
        }else{
            fx.retry = 1;
            fx.timeout_read = 10;
            fx.timeout_write = 10;
        }
        console.log( "-> timeout read: ", fx.timeout_read );
        console.log( "-> timeout write: ", fx.timeout_write );
        console.log( "-> timeout retry: ", fx.retry );

        if( fx.port ){
            // Cancela o reader e fecha o writer atuais
            if (fx.reader) {
                await fx.reader.cancel();
            }
            if (fx.writer) {
                await fx.writer.close();
            }

            // Cria novos writer e reader
            fx.writer = fx.port.writable.getWriter();
            fx.reader = fx.port.readable.getReader();
        }
    }
    
    const sel_link = document.getElementById("opcoes");
    //sel_link.addEventListener("change", selectLink(this.value));
    sel_link.addEventListener("change", (event) => selectLink(event.target.value));
    selectLink(sel_link.value);

    // ================================================

    cards_interval = null;
    let Cards = []
    const cards_container = document.getElementById("cards");

    // ===========================================================================
    // Sidebar e funções gerais
    // ===========================================================================
    // Função para aguardar um tempo específico
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // "buttons" -----------------------------------------
    async function toggleConnection() {
        
        if(fx.isConnected()){
            console.log("DESCONECTANDO...");
            await fx.disconnect();
        }else{
            console.log("CONECTANDO...");
            await fx.connect();
        }

        // atualiza o botão de conexão
        const startButton = document.querySelector('.start-btn');
        if( fx.isConnected() ){
            console.log("CONECTADO!!");
            startButton.classList.add('active');
            startButton.textContent = 'conectado';
        }else{
            console.log("DESCONECTADO!!");
            startButton.classList.remove('active');
            startButton.textContent = 'desconectado';
        }
    }


    // SCAN ------------------------------------------------
    async function scan() {
        if (!fx.isConnected()) {
            alert("Conecte primeiro a porta serial.");
            return;
        }

        // Ajusta elementos gráficos...
        document.getElementById("result").textContent = "Escaneando...";
        document.getElementById("scannedAddresses").innerHTML = "";
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("progressContainer").style.display = "block";
        const startButton = document.querySelector('.scan-btn');
        startButton.classList.add('active');
        startButton.textContent = "scanning...";
        
        clearCards();

        let validAddresses = [];

        await delay(200);

        console.log(`SCANNING`);

        // 1️⃣ **Verifica os endereços um por um**
        for (let i = 0; i <= 32; i++) {
            try {
                const ans = await fx.check(i,true); // Aguarda a resposta antes de continuar
                if (ans.ok) {
                    console.log(`ID check:`);
                    const ID = await fx.getID( i, true );
                    if( ID.ok ){
                        validAddresses.push({ addr: i, ID: ID.value });
                        console.log(`Endereço ${i}: arg ${ID.value}`);
                        document.getElementById("scannedAddresses").innerHTML += `Endereço ${i} (${ID.value})<br>`; //: arg ${ans.arg}<br>`;
                    }
                }
            } catch (error) {
                console.error(`Erro ao verificar endereço ${i}:`, error);
            }

            // Atualiza progress bar
            document.getElementById("progressBar").style.width = `${(i / 32) * 100}%`;
        }

        for (const i of validAddresses) {
            await addCard(i);
        }

        // Finaliza scan
        startButton.classList.remove('active');
        startButton.textContent = "scan";
        document.getElementById("progressBar").style.width = "100%";
        document.getElementById("result").textContent = "ok";

        // Atualização em tempo real dos graficos
        if( Cards.length ){
            cards_interval = setInterval( cards_update, 400 );
        }
    }

    async function addCard( device ) {
        if( device.ID == 1 ){
            const F = new fxs50(device.addr);
            await F.get_firmware_version();
            F.html();
            await F.read(true);
            Cards.push(F);
        }else if( device.ID == 0x20 ){
            const F = new IrKey(device.addr);
            await F.get_firmware_version();
            F.html();
            await F.read(true);
            Cards.push(F);
        }
    }

    function clearCards() {
        if( cards_interval ) clearInterval(cards_interval);
        // Esvazia o array e remove os elementos do DOM
        Cards = [];
        //document.getElementById("cards").innerHTML = "";
        cards_container.innerHTML = "";
    }

    async function cards_update(){
        //console.log("update");
        for (const card of Cards) {
            await card.update();
            await delay(30);
        }
    }

    console.log( "READ: ", FX_S50_REG.cmd.READ );

    // ================================================



    //for (let i = 0; i < 32; i++) {
    //    checksum = fx.checksum(i);
    //    console.log(`i: ${i} | binário: ${i.toString(2).padStart(8, '0')} | checksum: ${checksum} | ${checksum.toString(2).padStart(8, '0')}`);
    //}

    //async function begin(){
    //    await fx.command( 0x05, 0x03 );
    //}

    //async command( addr, cmd, val = null ) {
    //        //console.log( `checksum ${cmd} -> ${(this.checksum(cmd)<<5)}` );
    //        console.log( `[addr ${addr}] command: ${cmd} (${cmd.toString(2)}) val: ${val}` );
    //        addr = 0xC0|(addr & 0x1F);
    //        cmd = this.checksum(cmd);
    //        console.log( `|->[addr ${addr}] command: ${cmd.toString(2)} val: ${val}` );
    //        if( val ){
    //            val = val & 0xFF;
    //            return await this.WRITE( addr, cmd, val );
    //        }
    //        return await this.READ( addr, cmd );
    //    }

</script>

</body>
</html>