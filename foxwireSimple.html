<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>FoxWire Simple Tool</title>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: #eee;
            padding: 20px;
        }

        h2 {
            margin-top: 0;
        }

        .box {
            border: 1px solid #333;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 6px;
            background: #1a1a1a;
        }

        button {
            margin-right: 6px;
            padding: 6px 12px;
            cursor: pointer;
        }

        input {
            width: 80px;
            padding: 4px;
            margin-right: 6px;
        }

        .value {
            display: inline-block;
            min-width: 60px;
            font-weight: bold;
        }

        .row {
            margin-top: 6px;
        }

        button {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #444;
            border-radius: 4px;
        }

        button:hover {
            background: #333;
        }

        .value.ok {
            color: #0f0;
        }

        .value.err {
            color: #f44;
        }

        .value.idle {
            color: #aaa;
        }

        button.ok {
            background: #1f4;
            color: #000;
        }

        button.err {
            background: #f44;
            color: #000;
        }
    </style>
</head>
<body>

<h2>FoxWire – Simple Interface</h2>

<div class="box">
    <h3>Device</h3>
    <button id="btnConnect">Connect</button>
    Addr:
    <input id="deviceAddr" type="number" min="0" max="31" value="0">
    <button id="btnCheck">Check</button>
    <span class="value idle" id="deviceStatus">--</span>
</div>

<div class="box">
    <h3>Commands</h3>
    <button id="btnReset">Reset</button>
    <button id="btnRestore">Restore</button>
    <button id="btnSave">Save</button>
</div>

<div class="box">
    <h3>Register</h3>
    Reg:
    <input id="regAddr" type="number" min="0" max="31" value="0">
    Val:
    <input id="regWriteVal" type="number" min="0" max="255" value="0">
    <button id="btnRead">Read</button>
    <button id="btnWrite">Write</button>
    <span class="value idle" id="regValue">--</span>
</div>

<div class="box">
    <h3>Extended</h3>
    Addr:
    <input id="extAddr" type="number" value="0">
    Len:
    <input id="extLen" type="number" value="1">
    Val:
    <input id="extWriteVal" type="number" value="0">
    <button id="btnExtRead">Read</button>
    <button id="btnExtWrite">Write</button>
    <span class="value idle" id="extValue">--</span>
</div>

<script type="module">
    import { FoxWire, FX_BASE } from "./js/foxwire.js";

    const fx = new FoxWire(115200);
    window.fx = fx;
    let deviceAddr = 0; // endereço FoxWire do device

    const statusEl = document.getElementById("status");
    const regAddrEl = document.getElementById("regAddr");
    const regValueEl = document.getElementById("regValue");
    const deviceAddrEL = document.getElementById("deviceAddr");
    const connectBtnEL = document.getElementById("btnConnect");

    function updateConnectButton() {
        if (fx.isConnected()) {
            connectBtnEL.textContent = "Disconnect";
            connectBtnEL.className = "ok";
        } else {
            connectBtnEL.textContent = "Connect";
            connectBtnEL.className = "err";
        }
    }
    updateConnectButton();

    function getDeviceAddr(){
        deviceAddr = parseInt(deviceAddrEL.value, 10) & 0x1F;
        return deviceAddr;
    }

    connectBtnEL.onclick = async () => {
        if (fx.isConnected()) {
            await fx.disconnect();
            updateConnectButton();
            return;
        }
        connectBtnEL.textContent = "Connecting...";
        connectBtnEL.className = "";
        const ok = await fx.connect();
        updateConnectButton();
        if (!ok) {
            connectBtnEL.textContent = "Error";
            connectBtnEL.className = "err";
        }
    };


    // -------------------------
    // Buttons
    // -------------------------

    document.getElementById("btnReset").onclick = async () => {
        const ans = await fx.reset(getDeviceAddr());
        console.log("reset:", ans);
    };

    document.getElementById("btnRestore").onclick = async () => {
        const ans = await fx.default(getDeviceAddr());
        console.log("restore:", ans);
    };

    document.getElementById("btnSave").onclick = async () => {
        const ans = await fx.save(getDeviceAddr());
        console.log("save:", ans);
    };

    document.getElementById("btnRead").onclick = async () => {
        const regAddr = parseInt(regAddrEl.value, 10) & 0x1F;

        regValueEl.textContent = "...";

        const ans = await fx.registerRead(getDeviceAddr(), regAddr);

        if (ans && ans.ok && ans.data?.length) {
            const v = ans.data[0];
            regValueEl.textContent =
                "0x" + v.toString(16).padStart(2, "0") + " (" + v + ")";
        } else {
            regValueEl.textContent = "ERR";
        }
    };

    const deviceStatusEl = document.getElementById("deviceStatus");
    const regWriteValEl = document.getElementById("regWriteVal");
    const extAddrEl = document.getElementById("extAddr");
    const extLenEl = document.getElementById("extLen");
    const extWriteValEl = document.getElementById("extWriteVal");
    const extValueEl = document.getElementById("extValue");

    // -------------------------
    // Device check
    // -------------------------
    document.getElementById("btnCheck").onclick = async () => {
        deviceStatusEl.textContent = "...";
        deviceStatusEl.className = "value idle";

        const ans = await fx.check(getDeviceAddr());
        if (ans.ok) {
            deviceStatusEl.textContent = "OK";
            deviceStatusEl.className = "value ok";
        } else {
            deviceStatusEl.textContent = "FAIL";
            deviceStatusEl.className = "value err";
        }
    };

    // -------------------------
    // Register read
    // -------------------------
    document.getElementById("btnRead").onclick = async () => {
        const reg = parseInt(regAddrEl.value) & 0x1F;
        regValueEl.textContent = "...";
        regValueEl.className = "value idle";

        const ans = await fx.registerRead(getDeviceAddr(), reg);
        if (ans?.ok && ans.data?.length) {
            const v = ans.data[0];
            regValueEl.textContent = `0x${v.toString(16)} (${v})`;
            regValueEl.className = "value ok";
        } else {
            regValueEl.textContent = "ERR";
            regValueEl.className = "value err";
        }
    };

    // -------------------------
    // Register write
    // -------------------------
    document.getElementById("btnWrite").onclick = async () => {
        const reg = parseInt(regAddrEl.value) & 0x1F;
        const val = parseInt(regWriteValEl.value) & 0xFF;

        regValueEl.textContent = "...";
        regValueEl.className = "value idle";

        const ans = await fx.registerWrite(getDeviceAddr(), reg, val);
        regValueEl.textContent = ans.ok ? "OK" : "FAIL";
        regValueEl.className = ans.ok ? "value ok" : "value err";
    };

    // -------------------------
    // Extended read
    // -------------------------
    document.getElementById("btnExtRead").onclick = async () => {
        extValueEl.textContent = "...";
        extValueEl.className = "value idle";

        const addr = parseInt(extAddrEl.value);
        const len = parseInt(extLenEl.value);

        const ans = await fx.extendedRead(getDeviceAddr(), addr, len);
        if (ans?.ok) {
            extValueEl.textContent = fx.toHexLine(ans.data);
            extValueEl.className = "value ok";
        } else {
            extValueEl.textContent = "ERR";
            extValueEl.className = "value err";
        }
    };

    // -------------------------
    // Extended write (simples)
    // -------------------------
    document.getElementById("btnExtWrite").onclick = async () => {
        extValueEl.textContent = "...";
        extValueEl.className = "value idle";

        const addr = parseInt(extAddrEl.value);
        const val = parseInt(extWriteValEl.value) & 0xFF;

        const ans = await fx.extended(getDeviceAddr(), 0x81, [val], 1);
        extValueEl.textContent = ans?.ok ? "OK" : "FAIL";
        extValueEl.className = ans?.ok ? "value ok" : "value err";
    };

</script>

</body>
</html>
