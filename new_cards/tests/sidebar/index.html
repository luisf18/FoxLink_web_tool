<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scan Demo</title>
<link rel="stylesheet" href="sidebar.css">
</head>
<body>


<div class="sidebar">

    <div class="sidebar-header">
        <div class="brand-row">
            <div class="brand" onclick="openRepo()">
                <!--span class="brand-icon">ðŸ”—</span-->
                <span class="brand-text">FoxLink</span>
            </div>
            <span class="version">v0.4.2</span>
        </div>
        <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">
            <span class="dot"></span>
            <span class="text">Disconnected</span>
        </button>
    </div>

    <!-- ðŸ‘‡ NOVO BLOCO -->
    <div class="sidebar-controls">
        <button class="scan-btn" onclick="scanDevices()" disabled>Scan</button>

        <!-- Barra de progresso -->
        <div class="progress-wrap" id="progressWrap">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- BalÃ£o de dispositivos -->
        <div class="scan-results" id="scanResults">
            <div class="scan-title">Dispositivos encontrados</div>
            <div class="scan-list" id="scanList"></div>
        </div>
    </div>

    <div class="sidebar-footer">
        <img src="https://luisf18.github.io/FoxLink_web_tool/logo.png" class="footer-logo">
        <a href="https://github.com/luisf18/FoxLink_web_tool" target="_blank">
            FoxLink WebTool
        </a>
        <a href="https://github.com/luisf18/FXDevices/wiki" target="_blank">
            Wiki das Placas
        </a>
    </div>

</div>

<!-- Ãrea de cards -->
<div class="devices-container">
    <!-- Cards fake sÃ³ pra demo -->

    <div class="card inactive" id="card-1" data-addr="2">
        <div class="card-status">
            <span class="dot"></span>
            <span class="label">Offline</span>
        </div>
        <div class="card-body"> FX-S50 #2</div>
    </div>

    <div class="card inactive" id="card-2" data-addr="5">
        <div class="card-status">
            <span class="dot"></span>
            <span class="label">Offline</span>
        </div>
        <div class="card-body"> IR-KEY #5 </div>
    </div>

    <div class="card inactive" id="card-3" data-addr="8">
        <div class="card-status">
            <span class="dot"></span>
            <span class="label">Offline</span>
        </div>
        <div class="card-body"> ESC #8 </div>
    </div>

</div>

<script>
    let scanTimer = null;
    let foundAddrs = new Set();
    const addrToCardId = {
        2: "card-1",
        5: "card-2",
        8: "card-3"
    };
    let connected = false;

    function discoverDevice() {
        if (foundAddrs.size >= 16) return;

        let addr;
        do {
            addr = Math.floor(Math.random() * 16);
        } while (foundAddrs.has(addr));

        foundAddrs.add(addr);

        const results = document.getElementById("scanResults");
        const list    = document.getElementById("scanList");

        const div = document.createElement("div");
        div.className = "scan-item";
        div.textContent = `Addr ${addr}`;

        div.onclick = () => {
            const card = document.querySelector(`.card[data-addr="${addr}"]`);
            if (!card) return;

            card.classList.remove("blink");
            void card.offsetWidth;
            card.classList.add("blink");
        };

        list.appendChild(div);
        results.style.display = "block";

        // ðŸ”¥ ATIVA CARD SE EXISTIR
        const cardId = addrToCardId[addr];
        if (cardId) {
            setCardConnected(cardId, true);

            const card = document.getElementById(cardId);
            if (card) {
                card.classList.remove("blink");
                void card.offsetWidth; // reset da animaÃ§Ã£o
                card.classList.add("blink");
            }
        }

        div.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }


    function addScanResult(addr) {
        const results = document.getElementById("scanResults");
        const list    = document.getElementById("scanList");

        results.style.display = "block";

        const item = document.createElement("div");
        item.className = "scan-item";
        item.textContent = `Addr ${addr} â€“ FX-S50`;

        item.onclick = () => {
            const cardId = addrToCardId[addr];
            if (!cardId) return;

            const card = document.getElementById(cardId);
            card.classList.add("blink");
            setTimeout(() => card.classList.remove("blink"), 1200);
        };

        list.appendChild(item);
    }

    function setCardConnected(cardId, connected) {
        const card = document.getElementById(cardId);

        if (connected) {
            card.classList.remove("inactive");
            card.classList.add("connected");
            card.querySelector(".label").textContent = "Online";
        } else {
            card.classList.remove("connected");
            card.classList.add("inactive");
            card.querySelector(".label").textContent = "Offline";
        }
    }

    function toggleConnection() {
        const btn = document.getElementById("connectBtn");
        const scanBtn = document.querySelector(".scan-btn");

        connected = !connected;

        if (connected) {
            btn.classList.add("connected", "just-connected");
            btn.querySelector(".text").textContent = "Connected";
            scanBtn.disabled = false;

            setTimeout(() => {
                btn.classList.remove("just-connected");
            }, 800);

        } else {
            btn.classList.remove("connected", "just-connected");
            btn.querySelector(".text").textContent = "Disconnected";
            scanBtn.disabled = true;
        }
    }


    function openRepo() {
        window.open(
            "https://github.com/luisf18/FoxLink_web_tool",
            "_blank"
        );
    }


    function scanDevices() {
        const progressWrap = document.getElementById("progressWrap");
        const progressBar  = document.getElementById("progressBar");
        const results      = document.getElementById("scanResults");
        const list         = document.getElementById("scanList");

        if (scanTimer) clearInterval(scanTimer);
        foundAddrs.clear();

        // ðŸ”’ coloca todos os cards como offline
        Object.values(addrToCardId).forEach(id => {
            setCardConnected(id, false);
        });

        list.innerHTML = "";
        results.style.display = "none";
        progressWrap.style.display = "block";
        progressBar.style.width = "0%";

        let progress = 0;

        scanTimer = setInterval(() => {
            progress += Math.random() * 6 + 2;
            if (progress > 100) progress = 100;

            progressBar.style.width = progress + "%";

            if (Math.random() < 0.35) {
                discoverDevice();
            }

            if (progress >= 100) {
                clearInterval(scanTimer);
                progressWrap.style.display = "none";
            }
        }, 180);
    }

    function blinkCard(addr) {
        const card = document.querySelector(`.card[data-addr="${addr}"]`);
        if (!card) return;

        card.classList.remove("blink");
        void card.offsetWidth; // forÃ§a reset
        card.classList.add("blink");
    }


</script>
</body>
</html>
