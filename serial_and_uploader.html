<!DOCTYPE html>
<html lang="pt-BR">


<head>
  <meta charset="UTF-8">
  <title>Serial Monitor Web</title>
  <!--link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2216%22>ü¶ä</text></svg>"-->
  <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'>
    <rect width='16' height='16' rx='3' fill='%23ff8000'/>
    <text x='8' y='12.5'
            text-anchor='middle'
            font-size='12'
            fill='white'>üîß</text>
    </svg>">

  <style>

body {
    font-family: system-ui, sans-serif;
    background: #f5f5f5;
    padding: 20px;
    
}

.toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

h2{
    font-size: 22px;
    font-weight: 700;
    color: #ff8b39;
}

.left-buttons, .right-buttons {
    display: flex;
    gap: 6px;
}

button {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #ccc;
    color: #fff;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

button.connected { background: #2ecc71; }
button.active { background: #ff974d; }
button.inactive { background: #666; }
button.disconnect { background: #e74c3c; }
button.reset-ready { background: #3498db; }
button.clear-ready { background: #e74c3c; }
button.clear-empty { background: #555; }

#log {
    background: #000;
    color: #0f0;
    font-family: monospace;
    padding: 10px;
    height: 320px;
    overflow-y: auto;
    border-radius: 6px;
    white-space: pre-wrap;
}

.input-area {
    display: flex;
    align-items: center;
    margin-top: 6px;
    gap: 6px;
}

#cmd {
    flex: 1;
    padding: 8px;
    font-family: monospace;
    border-radius: 6px;
    border: 1px solid #ccc;
}

.input-area select {
    /* seu estilo aqui */
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    font-family: monospace;
}

.presets {
    margin-top: 6px;
    display: flex;
    gap: 6px;
}

.preset-title {
    margin-top: 14px;
    margin-bottom: 6px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: #888;
    border-left: 4px solid #ff8b39;
    padding-left: 8px;
}

/*uploader*/

.uploader-box {
    margin-top: 10px;
    padding: 10px;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-size: 13px;
}

.uploader-row {
    display: flex;
    gap: 6px;
    align-items: center;
}

.uploader-row select {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-family: monospace;
}

.file-btn {
    background: #ff8b39;
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
}

.file-btn input {
    display: none;
}

.fw-size {
    font-family: monospace;
    color: #666;
    min-width: 70px;
    text-align: right;
}

.advanced-toggle {
    margin-top: 8px;
    cursor: pointer;
    font-size: 12px;
    color: #ff8b39;
    user-select: none;
}

.advanced-panel {
    margin-top: 6px;
    display: none;
    flex-direction: column;
    gap: 6px;
}

.advanced-panel input[type="text"] {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-family: monospace;
}

.upload-btn {
    margin-top: 10px;
    width: 100%;
    background: #2ecc71;
}

.boot-log {
    margin-top: 8px;
    background: #111;
    color: #0f0;
    font-family: monospace;
    font-size: 12px;
    padding: 6px;
    border-radius: 6px;
    height: 90px;
    overflow-y: auto;
    white-space: pre-wrap;
}

/*=======================
   footer
========================*/


.footer {
    margin-top: 20px;
    padding-top: 8px;
    font-size: 12px;
    text-align: center;
    color: #999;
    border-top: 1px solid #ddd;
}

.footer strong {
    color: #ff8b39;
    font-weight: 700;
}

</style>
</head>
<body>

<h2>
  <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" 
       class="bi bi-terminal" viewBox="0 0 16 16" style="vertical-align: middle; margin-bottom: 5px;">
    <path d="M6 9a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 9M3.854 4.146a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708z"/>
    <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/>
  </svg>
  Serial Monitor Web
</h2>

<div class="toolbar">
    <div class="left-buttons">
        <button id="connectBtn">Conectar</button>
        <button id="saveBtn" onclick="downloadLog()" title="Save log">üíæ</button>
    </div>
    <div class="right-buttons">
        <button id="hexBtn" onclick="toggleHex()" title="Hex dump mode">HEX</button>
        <button id="rstBtn" onclick="dtrReset()" title="DTR Reset">RST</button>
        <button id="txBtn" onclick="toggleTx()" title="Show TX mensages on log">TX</button>
        <button id="scrollBtn" onclick="toggleScroll()" title="Auto scroll">‚¨á</button>
        <button id="timeBtn" onclick="toggleTime()" title="Show timestamp">‚è±</button>
        <button id="clearBtn" onclick="clearLog()" title="Clear log">X</button>
    </div>
</div>

<div id="log"></div>

<div class="input-area">
    <input id="cmd" placeholder="Digite comando e pressione Enter">
    <select id="lineEnding">
        <option value="" >none</option>
        <option value="NL" selected>\n</option>
        <option value="CR">\r</option>
        <option value="CRNL">\n\r</option>
    </select>
    <select id="baudRate" title="Baudrate">
        <option value="300">300 baud</option>
        <option value="600">600 baud</option>
        <option value="750">750 baud</option>
        <option value="1200">1200 baud</option>
        <option value="2400">2400 baud</option>
        <option value="4800">4800 baud</option>
        <option value="9600">9600 baud</option>
        <option value="14400">14400 baud</option>
        <option value="19200">19200 baud</option>
        <option value="31250">31250 baud</option>
        <option value="38400">38400 baud</option>
        <option value="57600">57600 baud</option>
        <option value="74880">74880 baud</option>
        <option value="115200" selected>115200 baud</option>
        <option value="230400">230400 baud</option>
        <option value="250000">250000 baud</option>
        <option value="460800">460800 baud</option>
        <option value="500000">500000 baud</option>
        <option value="921600">921600 baud</option>
        <option value="1000000">1000000 baud</option>
        <option value="2000000">2000000 baud</option>
    </select>
</div>

<h3 class="preset-title">Preset Mensagens</h3>
<div class="presets">
    <button onclick="send('FOX-SHELL\n\r',false)" title="inicia foxshell">ü¶ä FOX-SHELL</button>
    <button onclick="send('reset')" title="foxshell reset" >reset</button>
    <button onclick="send('help')" title="foxshell help" >help</button>
    <button onclick="send('dump')" title="foxshell dump" >dump</button>
</div>

<h3 class="preset-title">Firmware Upload</h3>

<div class="uploader-box">

    <div class="uploader-row">
        <select id="boardSelect">
            <option value="">Selecione a placa</option>
            <option value="uno">Arduino UNO</option>
            <option value="nano">Arduino Nano</option>
            <option value="mega">Arduino Mega</option>
            <option value="custom">Custom / Fox</option>
        </select>

        <label class="file-btn">
            Importar firmware
            <input type="file" id="fwFile" accept=".hex,.bin">
        </label>

        <span class="fw-size" id="fwSize">0 B</span>
    </div>

    <div class="advanced-toggle" onclick="toggleAdvanced()">
        ‚ñ∏ Advanced
    </div>

    <div class="advanced-panel" id="advancedPanel">
        <button class="boot-sync-btn" onclick="bootSync()">
            üîÑ Sync bootloader
        </button>

        <label><input type="checkbox" id="eraseFlash"> Erase flash</label>
        <label><input type="checkbox" id="autoReset" checked> Auto reset</label>

        <input type="text" id="bootCmd"
               placeholder="Bootloader command (ex: 0x7F)">
        
        <div class="boot-log" id="bootLog"></div>
    </div>

    <button class="upload-btn">Upload firmware</button>

</div>

<footer class="footer">
    <span>Powered by</span>
    <strong>Fox Dynamics</strong>
</footer>

<script src="uploader/stk500.js" ></script>
<script>

function toggleHex() {
    showHex = !showHex;
    const btn = document.getElementById("hexBtn");
    btn.classList.toggle("active", showHex);
    btn.classList.toggle("inactive", !showHex);

    hexBuffer = []; // limpa ao alternar modo
}


function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function timestamp() { return new Date().toLocaleTimeString("pt-BR"); }

function appendLine(text, outgoing=false) {
    if(outgoing){
        const lastSpan = logDiv.lastChild;
        if (lastSpan && lastSpan instanceof HTMLSpanElement) {
            if (!lastSpan.textContent.endsWith("\n")) lastSpan.textContent += "\n";
        }
    }
    const span = document.createElement("span");
    let line = "";
    if (showTime) line += `[${timestamp()}] `;
    if (outgoing) line += "> ";
    line += text;
    span.textContent = line;
    logDiv.appendChild(span);
    if (autoScroll) logDiv.scrollTop = logDiv.scrollHeight;
}

async function toggleConnection() {
    if (connected) {
        await disconnect();
    } else {
        await connect();
    }
}

async function connect() {
    await initSerial(
        getBaudrate(),
        true
    );
}

function getBaudrate(){
    return ( parseInt(document.getElementById("baudRate").value) || 115200 );
}

async function initSerial( baud = 115200, newPort = false ) {
    //requestPort = true
    //const baud = baudrate ? baudrate : parseInt(document.getElementById("baudRate").value) || 115200;

    // Se j√° conectado no mesmo baud, n√£o faz nada
    if ( (!newPort) && connected && port && port._baudRate === baud) return;

    // Se j√° conectado, mas baud diferente, desconecta antes
    if (connected) {
        await disconnect();
    }

    // Se ainda n√£o temos porta, pede para o usu√°rio escolher
    // ou se baud n esta declarado -> oq indica que n √© altera√ß√£o de baud
    if ( !port || newPort) {
        port = await navigator.serial.requestPort();
    }

    //if( newPort ){
    //    console.log(`new port[${newPort}]:`,port);
    //    port = await navigator.serial.requestPort();
    //}

    await port.open({ baudRate: baud });
    port._baudRate = baud;  // guarda o baud usado na pr√≥pria porta
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    connected = true;

    connectBtn.className = "connected";
    connectBtn.textContent = `COM ${port.getInfo().usbProductId || ""}`;
    rstBtn.className    = "reset-ready";
    timeBtn.className   = showTime ? "active" : "inactive";
    scrollBtn.className = autoScroll ? "active" : "inactive";
    txBtn.className     = showTx ? "active" : "inactive";
    clearBtn.className = "clear-empty";
    saveBtn.className  = "";

    const presetButtons = document.querySelectorAll('.presets button');
    presetButtons.forEach(btn => btn.classList.add('active'));

    //updateUI();
    readLoop();
}

async function disconnect() {
    connected = false;

    try {
        if (reader) { await reader.cancel(); reader.releaseLock(); reader = null; }
        if (writer) { writer.releaseLock(); writer = null; }
        if (port) await port.close();
    } catch(e) { console.error(e); }

    //updateUI();
    connectBtn.className = "disconnect";
    connectBtn.textContent = "Conectar";
    rstBtn.className = "inactive";
    timeBtn.className = "inactive";
    scrollBtn.className = "inactive";
    txBtn.className = "inactive";
    clearBtn.className = "clear-empty";
    saveBtn.className = "";
    const presetButtons = document.querySelectorAll('.presets button');
    presetButtons.forEach(btn => btn.classList.remove('active'));
}

async function readLoop() {
    hexBuffer = [];
    let lastSpan = null;
    const decoder = new TextDecoder();
    while (connected) {
        const { value, done } = await reader.read();
        if (done) break;

        clearBtn.className = "disconnect";
        saveBtn.className  = "active";

        //console.log("receive:",value);
        //console.log("str:",rxBuffer);
        if (showHex) {
            // adiciona bytes novos
            hexBuffer.push(...value);

            // fecha todas as linhas completas dispon√≠veis
            while (hexBuffer.length >= hexCols) {

                const lineBytes = hexBuffer.slice(0, hexCols);
                hexBuffer.splice(0, hexCols);

                // se tinha linha parcial, reaproveita
                if (!lastSpan) {
                    lastSpan = document.createElement("span");
                    logDiv.appendChild(lastSpan);
                }

                lastSpan.innerHTML = formatHexLine(lineBytes);

                // linha agora √© definitiva
                lastSpan = null;
            }

            // sobrou parcial ‚Üí re-renderiza
            if (hexBuffer.length > 0) {

                if (!lastSpan) {
                    lastSpan = document.createElement("span");
                    logDiv.appendChild(lastSpan);
                }

                lastSpan.innerHTML = formatHexLine(hexBuffer);
            }

            if (autoScroll) logDiv.scrollTop = logDiv.scrollHeight;
        }else {
            rxBuffer += decoder.decode(value);
            let idx;
            while ((idx = rxBuffer.indexOf("\n")) >= 0) {
                const line = rxBuffer.slice(0, idx + 1);
                rxBuffer = rxBuffer.slice(idx + 1);
                appendLine(line);
            }
        }
    }
}

async function send(text, setEnd = true) {
    if (!connected) return;
    clearBtn.className = "disconnect";
    saveBtn.className   = "active";
    let ending = "";
    if( setEnd ){
        endValue = document.getElementById("lineEnding").value;
        if( endMap.has( endValue ) ){
            ending = endMap.get(endValue);
        }
    }
    const fullText = text + ending;
    const bytes = new TextEncoder().encode(fullText);
    //console.log( `send:`,bytes);
    await writer.write(bytes);
    if( showTx ){
        appendLine(fullText, true);
    }
}

function formatHexLine(bytes) {
    const hex = bytes
        .map(b => b.toString(16).padStart(2, "0"))
        .join(" ");

    const ascii = bytes
        .map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : ".")
        .join("");

    // dois spans ‚Üí estiliza√ß√£o separada se quiser depois
    return `<span class="hex-bytes">${hex.padEnd(hexCols * 3)}</span> <span class="hex-ascii">${ascii}</span>\n`;
}

function sendPreset(t) { send(t); }

async function dtrReset() {
    rstBtn.className = "inactive";
    if (!port) return;
    await port.setSignals({ dataTerminalReady: false });
    await sleep(20);
    await port.setSignals({ dataTerminalReady: true });
    rstBtn.className = "reset-ready";
}

function clearLog() {
    logDiv.innerHTML = "";
    clearBtn.className = "clear-empty";
    saveBtn.className  = "";
}

function downloadLog() {
    const text = logDiv.innerText;
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "serial_log.txt";
    a.click();
    URL.revokeObjectURL(url);
}

function toggleTx() {
    showTx = !showTx;
    const btn = document.getElementById("txBtn");
    btn.classList.toggle("active", showTx);
    btn.classList.toggle("inactive", !showTx);
}

function toggleScroll() {
    autoScroll = !autoScroll;
    const btn = document.getElementById("scrollBtn");
    btn.classList.toggle("active", autoScroll);
    btn.classList.toggle("inactive", !autoScroll);
}

function toggleTime() {
    showTime = !showTime;
    const btn = document.getElementById("timeBtn");
    btn.classList.toggle("active", showTime);
    btn.classList.toggle("inactive", !showTime);
}


/* =====================================
    Uploader
=======================================*/

let uploadMode = false;
const fwFile = document.getElementById("fwFile");
const fwSize = document.getElementById("fwSize");
const advPanel = document.getElementById("advancedPanel");

fwFile.addEventListener("change", () => {
    const file = fwFile.files[0];
    if (!file) return;
    fwSize.textContent = file.size + " B";
});

function toggleAdvanced() {
    advPanel.style.display =
        advPanel.style.display === "flex" ? "none" : "flex";
}

function bootLog(text) {
    const el = document.getElementById("bootLog");
    el.textContent += text + "\n";
    el.scrollTop = el.scrollHeight;
}

async function stopMonitor() {
    if (reader) {
        await reader.cancel();
        reader.releaseLock();
        reader = null;
    }
}

async function startUploadMode() {
    uploadMode = true;
    await stopMonitor();
    reader2 = port.readable.getReader();
}

async function stopUploadMode() {
    uploadMode = false;
    if (reader2) {
        reader2.releaseLock();
        reader2 = null;
    }
    reader = port.readable.getReader();
    readLoop();
}

async function flushSerial(timeout = 100) {
    const start = performance.now();
    while (performance.now() - start < timeout) {
        const { value, done } = await reader.read();
        if (done || !value) break;
        // descarta tudo
    }
}

async function readBytes(_reader, n, timeout = 1000) {
    const buffer = [];
    const start = Date.now();

    while (buffer.length < n) {
        if (Date.now() - start > timeout) {
            return { value: null, ok: false };
        }

        const { value, done } = await _reader.read();

        if (done) {
            return { value: null, ok: false };
        }

        if (value && value.length) {
            buffer.push(...value);
        }
    }

    return {
        value: new Uint8Array(buffer.slice(0, n)),
        ok: true
    };
}

async function bootSync() {
    if (!connected || !port) return;

    await initSerial( 115200 );
    await startUploadMode();
    bootLog("Reset...");
    await port.setSignals({ dataTerminalReady: false });
    await sleep(10);
    await port.setSignals({ dataTerminalReady: true });
    await sleep(400);

    const cmd = new Uint8Array([0x30, 0x20]);
    await writer.write(cmd);
    bootLog("TX: 30 20");

    const {value, ok} = await readBytes(reader2, 2);
    if( ok ){
        const hex = [...value]
            .map(b => b.toString(16).padStart(2, "0"))
            .join(" ");
        bootLog("RX chunk: " + hex);
        
        //bootLog("Write EEPROM: 0x0000");
        //await writeEEPROM(0x0000, new Uint8Array([0xAA, 0xBB, 0xCC, 0xDD]));
        const data = await readEEPROM(0x0000, 255);
        bootLog("Read EEPROM 0x0000: " + [...data].map(b => b.toString(16)));
    }

    bootLog("end");

    await stopUploadMode();
}


/* =====================================
    Globals
=======================================*/

let history = [];
let historyIndex = -1;

let port, reader, reader2, writer;
let connected = false;
let autoScroll = true;
let showTime = false;
let showTx = true;
let showHex = false;
const hexCols = 8;
const logDiv = document.getElementById("log");

// Buttons
const connectBtn = document.getElementById("connectBtn");
const rstBtn     = document.getElementById("rstBtn");
const scrollBtn  = document.getElementById("scrollBtn");
const timeBtn    = document.getElementById("timeBtn");
const clearBtn   = document.getElementById("clearBtn");
const saveBtn    = document.getElementById("saveBtn");
const txBtn      = document.getElementById("txBtn");
let rxBuffer = "";

const endMap = new Map([
    ["CR", "\r"],       // Carriage Return
    ["NL", "\n"],       // New Line / Line Feed
    ["NLCR", "\n\r"]    // Carriage Return + Line Feed
]);

const cmd = document.getElementById("cmd");
cmd.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        const t = cmd.value;
        if (!t.trim()) return;
        send(t);
        history.push(t);
        historyIndex = history.length;
        cmd.value = "";
    }
    else if (e.key === "ArrowUp") {
        if (history.length === 0) return;
        historyIndex = Math.max(0, historyIndex - 1);
        cmd.value = history[historyIndex] || "";
    }
    else if (e.key === "ArrowDown") {
        if (history.length === 0) return;
        historyIndex = Math.min(history.length, historyIndex + 1);
        if (historyIndex === history.length) cmd.value = "";
        else cmd.value = history[historyIndex];
    }
});

document.getElementById("baudRate").addEventListener("change", async (e) => {
    if( !connected ) return;
    await initSerial( getBaudrate() );
});

connectBtn.onclick = toggleConnection;

</script>

</body>
</html>
